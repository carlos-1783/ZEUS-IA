import{r as S,U as T}from"./vendor-b50a21e2.js";var i=(e=>(e.CONNECT="connect",e.DISCONNECT="disconnect",e.RECONNECT="reconnect",e.RECONNECTING="reconnecting",e.MESSAGE="message",e.SYSTEM_STATUS="system_status",e.AUTH_RESPONSE="auth_response",e.ERROR="error",e.AUTH_ERROR="auth_error",e.CONNECTION_ERROR="connection_error",e.STATUS_UPDATE="status_update",e.CUSTOM="custom",e))(i||{});const o=S("disconnected"),f=S(!1),a=S(null);let r=null,p=0;const y=3;let u=null,N=null;const l={};Object.values(i).forEach(e=>{l[e]=new Set});const O=()=>{r&&(r.close(1e3,"Componente desmontado"),r=null),u&&(clearTimeout(u),u=null)},c={addEventListener(e,t){const s=e;return l[s]||(l[s]=new Set),l[s].add(t),()=>{this.removeEventListener(e,t)}},removeEventListener(e,t){const s=e;l[s]&&l[s].delete(t)},emit(e,t){const s={type:e,data:t,timestamp:new Date().toISOString()},h=l[e];h&&h.forEach(w=>{try{w(s)}catch{}})},_scheduleReconnect(){if(p>=y){o.value="error";return}const e=Math.min(1e3*Math.pow(1.5,p),3e3);p++,o.value="reconnecting",u=setTimeout(()=>{requestAnimationFrame(()=>{N&&this.connect(N).catch(t=>{p<y&&this._scheduleReconnect()})})},e)},async connect(e){try{if(r&&this.disconnect(),!e||e.trim()==="")throw new Error("No se proporcionó un token de autenticación válido");try{const d=JSON.parse(atob(e.split(".")[1])),m=Math.floor(Date.now()/1e3);if(d.exp&&d.exp<m)throw new Error("El token de autenticación ha expirado")}catch{}N=e,o.value="connecting",a.value=null;const t=`client-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,s=!1;let h;if(!s)return!1;const w=new URL(h);return w.searchParams.set("token",e),new Promise((d,m)=>{try{r=new WebSocket(w.toString()),r.binaryType="arraybuffer";const E=setTimeout(()=>{if(r&&r.readyState===WebSocket.CONNECTING){r.close(4e3,"Connection timeout");const n="Tiempo de conexión agotado";a.value=new Error(n),o.value="error",m(new Error(n))}},5e3);r.onopen=()=>{clearTimeout(E),f.value=!0,o.value="connected",p=0,this._startHeartbeat(),this.emit(i.CONNECT,{type:i.CONNECT}),d(!0)},r.onclose=n=>{clearTimeout(E),f.value=!1,n.code===1e3?o.value="disconnected":n.code===4e3?(o.value="error",a.value=new Error("Tiempo de conexión agotado")):n.code===1006?(o.value="error",a.value=new Error("Conexión cerrada inesperadamente")):n.code===1008?(o.value="error",a.value=new Error("Token de autenticación inválido o expirado")):(o.value="error",a.value=new Error(`Conexión cerrada con código: ${n.code}`)),n.code!==1e3&&n.code!==1001&&n.code!==1008&&(a.value=new Error(`Conexión cerrada: ${n.reason||"Código: "+n.code}`),this._scheduleReconnect()),this.emit(i.DISCONNECT,{type:i.DISCONNECT,code:n.code,reason:n.reason,wasClean:n.wasClean})},r.onerror=n=>{a.value=new Error("Error en la conexión WebSocket"),this.emit(i.ERROR,{type:i.ERROR,error:n}),o.value==="connecting"&&m(new Error("Error en la conexión WebSocket"))},r.onmessage=n=>{try{const C=typeof n.data=="string"?JSON.parse(n.data):n.data;this.emit(C.type||"message",C)}catch{}}}catch(E){a.value=E instanceof Error?E:new Error("Error al crear la conexión WebSocket"),o.value="error",m(E)}})}catch(t){throw o.value="error",a.value=t instanceof Error?t:new Error(String(t)),a.value}},disconnect(){if(this._stopHeartbeat(),r)try{(r.readyState===WebSocket.OPEN||r.readyState===WebSocket.CONNECTING)&&r.close(1e3,"User disconnected"),r.onopen=null,r.onclose=null,r.onerror=null,r.onmessage=null,r=null}catch{}u&&(clearTimeout(u),u=null),o.value="disconnected",f.value=!1},async send(e){if(!r)throw new Error("WebSocket no inicializado");if(r.readyState!==WebSocket.OPEN)throw new Error("WebSocket no está conectado");const t=typeof e=="string"?e:JSON.stringify(e);r.send(t)},get currentStatus(){return o.value},get isConnected(){return f.value},get currentError(){return a.value},_startHeartbeat(){},_stopHeartbeat(){},cleanup(){this._stopHeartbeat(),O()},useWebSocket(){const e=()=>{Object.values(i).forEach(t=>{l[t].clear()})};return{connect:c.connect.bind(c),disconnect:c.disconnect.bind(c),send:c.send.bind(c),addEventListener:c.addEventListener.bind(c),removeEventListener:c.removeEventListener.bind(c),cleanup:e,status:T(o),isConnected:T(f),error:T(a)}}},g=c.useWebSocket.bind(c);export{g as u};
