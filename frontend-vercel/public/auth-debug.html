<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Depuración de Autenticación</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            color: #333;
        }
        .container {
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            background-color: white;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        h1, h2, h3 {
            color: #2c3e50;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px 0;
            font-size: 14px;
        }
        button:hover {
            background-color: #2980b9;
        }
        pre {
            background-color: #f5f5f5;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
            overflow-y: auto;
        }
        .success { color: #27ae60; }
        .error { color: #e74c3c; }
        .warning { color: #f39c12; }
        .info { color: #3498db; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Depuración de Autenticación</h1>
        <p>Esta herramienta ayuda a diagnosticar problemas de autenticación en la aplicación.</p>
        
        <div class="section">
            <h2>1. Estado del Navegador</h2>
            <div id="browser-status">
                <p>Verificando estado del navegador...</p>
            </div>
            <button onclick="checkBrowserStatus()">Verificar Navegador</button>
        </div>
        
        <div class="section">
            <h2>2. Almacenamiento Local (localStorage)</h2>
            <div id="storage-status">
                <p>Estado del almacenamiento local:</p>
                <pre id="storage-content">Cargando...</pre>
            </div>
            <button onclick="checkLocalStorage()">Verificar localStorage</button>
            <button onclick="clearLocalStorage()" style="background-color: #e74c3c;">Limpiar localStorage</button>
        </div>
        
        <div class="section">
            <h2>3. Prueba de Autenticación</h2>
            <div>
                <label for="email">Email:</label><br>
                <input type="email" id="email" value="marketingdigitalper.seo@gmail.com" style="width: 100%; padding: 8px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 4px;">
                
                <label for="password">Contraseña:</label><br>
                <input type="password" id="password" value="Carnay19!" style="width: 100%; padding: 8px; margin: 5px 0 15px 0; border: 1px solid #ddd; border-radius: 4px;">
                
                <button onclick="testLogin()" style="background-color: #2ecc71; width: 100%; padding: 12px; font-size: 16px; margin: 10px 0;">Probar Inicio de Sesión</button>
                
                <div id="login-result">
                    <p>Resultado de la prueba aparecerá aquí...</p>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h2>4. Estado de la Sesión</h2>
            <div id="session-status">
                <p>Estado actual de la sesión:</p>
                <pre id="session-content">Cargando...</pre>
            </div>
            <button onclick="checkSessionStatus()">Verificar Estado de la Sesión</button>
        </div>
        
        <div class="section">
            <h2>5. Prueba de API</h2>
            <p>Prueba de conexión al endpoint de verificación de usuario:</p>
            <button onclick="testApiCall()">Probar API /me</button>
            <div id="api-result">
                <p>Resultado de la prueba de API aparecerá aquí...</p>
            </div>
        </div>
        
        <div class="section">
            <h2>6. Información del Sistema</h2>
            <div id="system-info">
                <p>Cargando información del sistema...</p>
            </div>
            <button onclick="gatherSystemInfo()">Obtener Información del Sistema</button>
        </div>
    </div>

    <script>
        // Mostrar información del sistema
        function gatherSystemInfo() {
            const info = {
                userAgent: navigator.userAgent,
                platform: navigator.platform,
                language: navigator.language,
                cookiesEnabled: navigator.cookieEnabled,
                localStorage: (function() {
                    try {
                        localStorage.setItem('test', 'test');
                        localStorage.removeItem('test');
                        return 'Disponible';
                    } catch (e) {
                        return 'No disponible: ' + e.message;
                    }
                })(),
                sessionStorage: (function() {
                    try {
                        sessionStorage.setItem('test', 'test');
                        sessionStorage.removeItem('test');
                        return 'Disponible';
                    } catch (e) {
                        return 'No disponible: ' + e.message;
                    }
                })(),
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone,
                screen: {
                    width: window.screen.width,
                    height: window.screen.height,
                    colorDepth: window.screen.colorDepth
                },
                windowSize: {
                    width: window.innerWidth,
                    height: window.innerHeight
                },
                online: navigator.onLine ? 'En línea' : 'Sin conexión',
                doNotTrack: navigator.doNotTrack === '1' ? 'Activado' : 'Desactivado',
                hardwareConcurrency: navigator.hardwareConcurrency || 'No disponible',
                deviceMemory: navigator.deviceMemory || 'No disponible',
                connection: (navigator.connection || navigator.mozConnection || navigator.webkitConnection) ? 
                    JSON.stringify(navigator.connection || navigator.mozConnection || navigator.webkitConnection, null, 2) : 'No disponible'
            };
            
            document.getElementById('system-info').innerHTML = `
                <h3>Información del Navegador</h3>
                <pre>${JSON.stringify(info, null, 2)}</pre>
            `;
        }

        // Verificar estado del navegador
        function checkBrowserStatus() {
            const status = {
                'Navegador': navigator.userAgent,
                'Plataforma': navigator.platform,
                'Cookies habilitadas': navigator.cookieEnabled ? 'Sí' : 'No',
                'Modo fuera de línea': navigator.onLine ? 'No' : 'Sí',
                'Almacenamiento local': (function() {
                    try {
                        localStorage.setItem('test', 'test');
                        localStorage.removeItem('test');
                        return 'Funcionando correctamente';
                    } catch (e) {
                        return `Error: ${e.message}`;
                    }
                })(),
                'Tipo de página': window.self === window.top ? 'Página principal' : 'Iframe',
                'URL actual': window.location.href,
                'Origen': window.location.origin,
                'Protocolo': window.location.protocol
            };
            
            let statusHTML = '<ul>';
            for (const [key, value] of Object.entries(status)) {
                statusHTML += `<li><strong>${key}:</strong> ${value}</li>`;
            }
            statusHTML += '</ul>';
            
            document.getElementById('browser-status').innerHTML = statusHTML;
        }

        // Verificar localStorage
        function checkLocalStorage() {
            try {
                const storage = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key) {
                        storage[key] = localStorage.getItem(key);
                    }
                }
                
                document.getElementById('storage-content').textContent = JSON.stringify(storage, null, 2);
                
                // Verificar si las claves específicas existen
                const hasAuthToken = localStorage.getItem('auth_token') !== null;
                const hasRefreshToken = localStorage.getItem('refresh_token') !== null;
                
                let status = '<p>Estado del almacenamiento:</p><ul>';
                status += `<li>auth_token: ${hasAuthToken ? '✅ Presente' : '❌ Ausente'}</li>`;
                status += `<li>refresh_token: ${hasRefreshToken ? '✅ Presente' : '❌ Ausente'}</li>`;
                status += '</ul>';
                
                document.getElementById('storage-status').innerHTML = status;
                
            } catch (error) {
                document.getElementById('storage-content').textContent = `Error al acceder al localStorage: ${error.message}`;
            }
        }

        // Limpiar localStorage
        function clearLocalStorage() {
            if (confirm('¿Estás seguro de que deseas limpiar todo el almacenamiento local? Esto cerrará tu sesión.')) {
                try {
                    localStorage.clear();
                    document.getElementById('storage-content').textContent = 'Almacenamiento local limpiado correctamente.';
                    document.getElementById('storage-status').innerHTML = '<p>Almacenamiento local vacío.</p>';
                } catch (error) {
                    document.getElementById('storage-content').textContent = `Error al limpiar el almacenamiento: ${error.message}`;
                }
            }
        }

        // Probar inicio de sesión
        async function testLogin() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const resultDiv = document.getElementById('login-result');
            
            if (!email || !password) {
                resultDiv.innerHTML = '<p class="error">Por favor, ingresa email y contraseña.</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p class="info">Iniciando sesión...</p>';
            
            try {
                // 1. Primero probar con el endpoint de login
                const loginResponse = await fetch('http://localhost:8000/api/v1/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'Accept': 'application/json'
                    },
                    body: new URLSearchParams({
                        username: email,
                        password: password,
                        grant_type: 'password'
                    })
                });
                
                const loginData = await loginResponse.json();
                
                if (!loginResponse.ok) {
                    throw new Error(loginData.detail || 'Error en la autenticación');
                }
                
                // 2. Guardar tokens manualmente
                if (loginData.access_token) {
                    localStorage.setItem('auth_token', loginData.access_token);
                    
                    if (loginData.refresh_token) {
                        localStorage.setItem('refresh_token', loginData.refresh_token);
                    }
                    
                    // 3. Verificar el token guardado
                    const savedToken = localStorage.getItem('auth_token');
                    const tokenStatus = savedToken ? 
                        `✅ Token guardado correctamente (${savedToken.length} caracteres)` : 
                        '❌ Error al guardar el token';
                    
                    // 4. Verificar el usuario actual
                    let userInfo = '';
                    try {
                        const userResponse = await fetch('http://localhost:8000/api/v1/auth/me', {
                            headers: {
                                'Authorization': `Bearer ${savedToken}`,
                                'Accept': 'application/json'
                            }
                        });
                        
                        if (userResponse.ok) {
                            const userData = await userResponse.json();
                            userInfo = `\n\n✅ Usuario autenticado:\n${JSON.stringify(userData, null, 2)}`;
                        } else {
                            userInfo = `\n⚠️ No se pudo obtener la información del usuario: ${userResponse.status} ${userResponse.statusText}`;
                        }
                    } catch (userError) {
                        userInfo = `\n⚠️ Error al obtener información del usuario: ${userError.message}`;
                    }
                    
                    resultDiv.innerHTML = `
                        <div class="success">
                            <p>✅ Inicio de sesión exitoso</p>
                            <p>${tokenStatus}</p>
                            <pre>${JSON.stringify({
                                access_token: loginData.access_token ? '••••••••' + loginData.access_token.slice(-8) : null,
                                refresh_token: loginData.refresh_token ? '••••••••' + (loginData.refresh_token.slice ? loginData.refresh_token.slice(-8) : '') : null,
                                expires_in: loginData.expires_in,
                                token_type: loginData.token_type
                            }, null, 2)}</pre>
                            <pre>${userInfo}</pre>
                        </div>
                    `;
                    
                    // Actualizar la vista del almacenamiento
                    checkLocalStorage();
                    checkSessionStatus();
                    
                } else {
                    throw new Error('No se recibió el token de acceso en la respuesta');
                }
                
            } catch (error) {
                console.error('Error en testLogin:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <p>❌ Error en la autenticación</p>
                        <p>${error.message || 'Error desconocido'}</p>
                        ${error.response ? `<pre>${JSON.stringify(error.response.data || {}, null, 2)}</pre>` : ''}
                    </div>
                `;
            }
        }

        // Verificar estado de la sesión
        function checkSessionStatus() {
            const token = localStorage.getItem('auth_token');
            const refreshToken = localStorage.getItem('refresh_token');
            
            let tokenInfo = 'No hay token de acceso';
            let tokenPayload = null;
            
            if (token) {
                try {
                    // Decodificar el token JWT manualmente
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    
                    tokenPayload = JSON.parse(jsonPayload);
                    const expirationDate = tokenPayload.exp ? new Date(tokenPayload.exp * 1000) : null;
                    const now = new Date();
                    const isExpired = expirationDate ? expirationDate < now : false;
                    
                    tokenInfo = `
                        Token JWT válido: ${!isExpired ? '✅ Sí' : '❌ Expirado'}
                        Emitido para: ${tokenPayload.sub || 'Desconocido'}
                        Fecha de expiración: ${expirationDate ? expirationDate.toLocaleString() : 'No especificada'}
                        Tiempo restante: ${expirationDate ? 
                            (isExpired ? 
                                `Expirado hace ${Math.ceil((now - expirationDate) / 1000 / 60)} minutos` : 
                                `${Math.ceil((expirationDate - now) / 1000 / 60)} minutos restantes`) : 
                            'No aplicable'}
                    `;
                    
                } catch (e) {
                    tokenInfo = `Error al decodificar el token: ${e.message}`;
                }
            }
            
            const status = {
                'Autenticado': token ? '✅ Sí' : '❌ No',
                'Token de acceso': token ? '✅ Presente' : '❌ Ausente',
                'Token de actualización': refreshToken ? '✅ Presente' : '❌ Ausente',
                'Información del token': tokenInfo,
                'Tamaño del token': token ? `${token.length} caracteres` : 'N/A',
                'Tamaño del refresh token': refreshToken ? `${refreshToken.length} caracteres` : 'N/A',
                'Almacenamiento local soportado': (function() {
                    try {
                        const testKey = 'test_' + Date.now();
                        localStorage.setItem(testKey, 'test');
                        localStorage.removeItem(testKey);
                        return '✅ Sí';
                    } catch (e) {
                        return `❌ No: ${e.message}`;
                    }
                })()
            };
            
            let statusHTML = '<ul>';
            for (const [key, value] of Object.entries(status)) {
                statusHTML += `<li><strong>${key}:</strong> ${value}</li>`;
                
                // Si el valor es un string con saltos de línea, formatearlo como bloque de código
                if (typeof value === 'string' && value.includes('\n')) {
                    statusHTML += `<pre style="margin-left: 20px; background: #f5f5f5; padding: 10px; border-radius: 4px;">${value}</pre>`;
                }
            }
            statusHTML += '</ul>';
            
            document.getElementById('session-status').innerHTML = statusHTML;
            
            // Mostrar el payload del token si está disponible
            if (tokenPayload) {
                const tokenPayloadDiv = document.createElement('div');
                tokenPayloadDiv.innerHTML = `
                    <h3>Contenido del token:</h3>
                    <pre>${JSON.stringify(tokenPayload, null, 2)}</pre>
                `;
                document.getElementById('session-status').appendChild(tokenPayloadDiv);
            }
        }

        // Probar llamada a la API
        async function testApiCall() {
            const token = localStorage.getItem('auth_token');
            const resultDiv = document.getElementById('api-result');
            
            if (!token) {
                resultDiv.innerHTML = '<p class="error">No hay token de acceso. Por favor, inicia sesión primero.</p>';
                return;
            }
            
            resultDiv.innerHTML = '<p class="info">Realizando petición a la API...</p>';
            
            try {
                const response = await fetch('http://localhost:8000/api/v1/auth/me', {
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Accept': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    resultDiv.innerHTML = `
                        <div class="success">
                            <p>✅ Petición exitosa (${response.status})</p>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </div>
                    `;
                } else {
                    throw new Error(data.detail || 'Error en la petición');
                }
                
            } catch (error) {
                console.error('Error en testApiCall:', error);
                resultDiv.innerHTML = `
                    <div class="error">
                        <p>❌ Error en la petición</p>
                        <p>${error.message || 'Error desconocido'}</p>
                        ${error.response ? `<pre>${JSON.stringify(error.response.data || {}, null, 2)}</pre>` : ''}
                    </div>
                `;
            }
        }

        // Inicialización
        document.addEventListener('DOMContentLoaded', function() {
            checkBrowserStatus();
            checkLocalStorage();
            checkSessionStatus();
            gatherSystemInfo();
        });
    </script>
</body>
</html>
